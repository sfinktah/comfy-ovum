import{app as A}from"../../../scripts/app.js";import"/scripts/app.js";function m(o,t,e){if(!o){console.error("Tried to add callback to a non-existent object");return}if(t in o){const s=o[t],r=`__chainCallbackPrevReturn_${t}`;o[t]=function(){const n=s?.apply(this,arguments);try{this[r]=n}catch{}const i=e.apply(this,arguments);try{delete this[r]}catch{}return i!==void 0?i:n}}else o[t]=e}const R={trace:"debug",debug:"debug",info:"info",warn:"warn",error:"error"},S="ovum.logger.rules.v1";function b(o){return Array.isArray(o)?o.filter(Boolean).map(String):typeof o=="string"&&o.trim().length?o.split(/\s+/).map(t=>t.trim()).filter(Boolean):[]}function N(o,t,e){let s=t,r=e,n=o;return(s===n||s===r)&&(s=""),r===n&&(r=""),[n,r,s].join(":")}function v(o){const t=o?.class?String(o.class):"",e=o?.method?String(o.method):"",s=o?.nodeName?String(o.nodeName):"";return N(t,e,s)}function w(o){const t=v(o),e=o?.severity?String(o.severity):"debug",s=b(o?.tag),r=[];return t&&r.push(`[${t}]`),r.push(`[${e}]`),s.length&&r.push(`[${s.join(",")}]`),r.join("")}function O(o,t){if(!t||t.length===0)return t;const e=o?.class?String(o.class):"",s=o?.method?String(o.method):"",r=o?.nodeName?String(o.nodeName):"";return!e&&!s&&!r?t:t.filter(n=>{if(typeof n!="string")return!0;let i=e&&n.includes(`[${e}]`),a=s&&n.includes(s),l=r&&n.includes(r);if(e&&s&&n.includes(`[${e}]`)&&n.includes(s)||r&&(i||a)||i&&a||l){const u=n.replace(/\[.*?]/g,"").trim();if(!u||u===s||u===e||u===r)return!1}return!0})}function $(o){try{if(typeof localStorage<"u")return localStorage.getItem(o)}catch{}return null}function C(o,t){try{typeof localStorage<"u"&&localStorage.setItem(o,t)}catch{}}function p(o){if(typeof o!="string")return null;try{if(o.length>=2&&o[0]==="/"&&o.lastIndexOf("/")>0){const t=o.lastIndexOf("/"),e=o.slice(1,t),s=o.slice(t+1);return new RegExp(e,s)}return new RegExp(o)}catch{return null}}class _{static _initialized=!1;static _rules=[];static _stats={total:0,emitted:0,suppressed:0,bySeverity:Object.create(null),byTag:Object.create(null),bySource:Object.create(null),combos:Object.create(null),suppressedByRule:Object.create(null)};static init(){if(!this._initialized){this._initialized=!0,this._loadRules();try{typeof window<"u"&&(window.Logger=this)}catch{}}}static log(t,...e){this.init();const s=t&&typeof t.severity=="string"&&R[t.severity]?t.severity:"debug",r=R[s]||"log",n=b(t?.tag),i=t?.nodeName!==void 0&&t.nodeName?String(t.nodeName):null,a=v({...t,nodeName:i}),l=this._matchRules({severity:s,tags:n,source:a,nodeName:i}),c=l?.action?l.action==="allow":!0,u=l?.index;if(l&&typeof l.index=="number"){const h=this._rules[l.index];h&&(h._hits=(h._hits||0)+1,c?h._allowHits=(h._allowHits||0)+1:h._denyHits=(h._denyHits||0)+1)}if(this._updateStats({severity:s,tags:n,source:a},c,u),!c)return;const f=w({...t,severity:s,tag:n}),d=O(t,e);try{f?console[r](f,...d):console[r](...d)}catch{try{f?console.log(f,...d):console.log(...d)}catch{}}}static resetStats(){this._stats={total:0,emitted:0,suppressed:0,bySeverity:Object.create(null),byTag:Object.create(null),bySource:Object.create(null),combos:Object.create(null),suppressedByRule:Object.create(null)}}static getStats(){const t=e=>Object.assign({},e);return{total:this._stats.total,emitted:this._stats.emitted,suppressed:this._stats.suppressed,bySeverity:t(this._stats.bySeverity),byTag:t(this._stats.byTag),bySource:t(this._stats.bySource),combos:t(this._stats.combos),suppressedByRule:t(this._stats.suppressedByRule)}}static showStats(){const t=this.getStats();try{console.groupCollapsed?.("[Logger] Statistics")}catch{}try{console.info?.("[Logger] totals",{total:t.total,emitted:t.emitted,suppressed:t.suppressed})}catch{}try{console.table?.(t.bySeverity)}catch{try{console.info?.("[Logger] bySeverity",t.bySeverity)}catch{}}try{console.table?.(t.byTag)}catch{try{console.info?.("[Logger] byTag",t.byTag)}catch{}}try{console.table?.(t.bySource)}catch{try{console.info?.("[Logger] bySource",t.bySource)}catch{}}try{console.info?.("[Logger] rules",this.listRules())}catch{}try{console.groupEnd?.()}catch{}return t}static listRules(t=!1){if(this.init(),console.log("Logger Rules (processed in order):"),console.log("num  hits  action   criteria"),console.log("---  ----  ------   ---------"),this._rules.length===0){console.log("(no rules - default ACCEPT)");return}this._rules.forEach((e,s)=>{const r=(s+1).toString().padStart(3),n=(e&&typeof e._hits=="number"?e._hits:0).toString().padStart(4),i=e.action.toUpperCase().padEnd(6),a=this._formatRuleCriteria(e,t);console.log(`${r}  ${n}  ${i}   ${a}`)})}static list(t=!1){this.listRules(t)}static appendRule(t,e){let s=null,r;if(typeof t=="string"){const a=t.toLowerCase();(a==="allow"||a==="deny")&&(s=a),r=e}else r=t;if(!r||typeof r!="object")return;const n=s?{...r,action:s}:r,i=this._sanitizeRule(n);if(i)return this._rules.push(i),this._saveRules(),this._rules.length}static insertRule(t,e,s){let r=null,n;if(typeof e=="string"){const c=e.toLowerCase();c==="allow"||c==="deny"?(r=c,n=s):n=e}else n=e;if(!n||typeof n!="object")return;const i=r?{...n,action:r}:n,a=this._sanitizeRule(i);if(!a)return;let l=(typeof t=="number"?t:1)-1;return l<0&&(l=0),l>this._rules.length&&(l=this._rules.length),this._rules.splice(l,0,a),this._saveRules(),l+1}static deleteRule(t){if(typeof t=="number"){const e=t-1;return e<0||e>=this._rules.length?!1:(this._rules.splice(e,1),this._saveRules(),!0)}else if(typeof t=="object"){const e=this._findMatchingRuleIndex(t);return e===-1?!1:(this._rules.splice(e,1),this._saveRules(),!0)}return!1}static replaceRule(t,e,s){const r=t-1;if(r<0||r>=this._rules.length)return!1;let n=null,i;if(typeof e=="string"){const c=e.toLowerCase();c==="allow"||c==="deny"?(n=c,i=s):i=e}else i=e;if(!i||typeof i!="object")return!1;const a=n?{...i,action:n}:i,l=this._sanitizeRule(a);return l?(this._rules[r]=l,this._saveRules(),!0):!1}static flushRules(){this._rules=[],this._saveRules()}static getRuleCount(){return this._rules.length}static getRules(){return this.init(),this._rules.map((t,e)=>({num:e+1,...t}))}static addRule(t,e=null){return e!=null?this.insertRule(e+1,t)?this.getRules():void 0:this.appendRule(t)?this.getRules():void 0}static addAllowRule(t,e=null){return this.addRule({action:"allow",...t},e)}static addDenyRule(t,e=null){return this.addRule({action:"deny",...t},e)}static removeRule(t){return this.deleteRule(t)?this.getRules():void 0}static moveRule(t,e){if(t===e)return this.getRules();if(t<0||t>=this._rules.length)return;e<0&&(e=0),e>=this._rules.length&&(e=this._rules.length-1);const[s]=this._rules.splice(t,1);return this._rules.splice(e,0,s),this._saveRules(),this.getRules()}static clearRules(){this.flushRules()}static append(t,e){return this.appendRule(t,e)}static insert(t,e,s){return this.insertRule(t,e,s)}static delete(t){return this.deleteRule(t)}static replace(t,e,s){return this.replaceRule(t,e,s)}static setRules(t){this._rules=this._sanitizeRulesArray(Array.isArray(t)?t:[]),this._saveRules()}static _formatRuleCriteria(t,e=!1){const s=[];if(t.severity){const n=Array.isArray(t.severity)?t.severity:[t.severity];s.push(`severity ${n.join(",")}`)}if(t.tag){const n=Array.isArray(t.tag)?t.tag:[t.tag];s.push(`tag ${n.join(",")}`)}if(t.source){const n=Array.isArray(t.source)?t.source:[t.source];s.push(`source ${n.join(",")}`)}if(t.nodeName){const n=Array.isArray(t.nodeName)?t.nodeName:[t.nodeName];s.push(`nodeName ${n.join(",")}`)}s.length===0&&s.push("all");let r=s.join(" ");return t.comment&&(r+=` /* ${t.comment} */`),r}static _findMatchingRuleIndex(t){return this._rules.findIndex(e=>this._rulesMatch(e,t))}static _rulesMatch(t,e){if(t.action!==e.action)return!1;const s=h=>Array.isArray(h)?[...h].sort():typeof h=="string"?[h]:null,r=(h,g)=>h===null&&g===null?!0:h===null||g===null||h.length!==g.length?!1:h.every((y,x)=>y===g[x]),n=s(t.severity),i=s(e.severity);if(!r(n,i))return!1;const a=s(t.tag),l=s(e.tag);if(!r(a,l))return!1;const c=s(t.source),u=s(e.source);if(!r(c,u))return!1;const f=s(t.nodeName),d=s(e.nodeName);return r(f,d)}static _updateStats({severity:t,tags:e,source:s,nodeName:r},n,i){this._stats.total+=1,n?this._stats.emitted+=1:this._stats.suppressed+=1,this._stats.bySeverity[t]=(this._stats.bySeverity[t]||0)+1;const a=s||"(no-source)";this._stats.bySource[a]=(this._stats.bySource[a]||0)+1;const l=e&&e.length?e:["(no-tag)"];for(const c of l){this._stats.byTag[c]=(this._stats.byTag[c]||0)+1;const u=`${t}|${c}|${a}`;this._stats.combos[u]=(this._stats.combos[u]||0)+1}if(!n&&typeof i=="number"){const c=String(i);this._stats.suppressedByRule[c]=(this._stats.suppressedByRule[c]||0)+1}}static _matchRules({severity:t,tags:e,source:s,nodeName:r}){if(!Array.isArray(this._rules)||this._rules.length===0)return null;for(let n=0;n<this._rules.length;n++){const i=this._rules[n];if(!i||i.action!=="allow"&&i.action!=="deny")continue;const a=!i.severity||i._sevSet?.has(t)===!0||(i._sevRegex&&i._sevRegex.length>0?i._sevRegex.some(f=>f.test(t)):!1),l=!i.tag||this._ruleMatchesAnyTag(i,e),c=!i.source||i._srcSet?.has(s)===!0||(i._srcRegex&&i._srcRegex.length>0?i._srcRegex.some(f=>f.test(s)):!1),u=!i.nodeName||r!==null&&(i._nodeSet?.has(r)===!0||(i._nodeRegex&&i._nodeRegex.length>0?i._nodeRegex.some(f=>f.test(r)):!1));if(a&&l&&c&&u)return{index:n,action:i.action}}return null}static _ruleMatchesAnyTag(t,e){if(!t.tag)return!0;if(!e||e.length===0)return!1;for(const s of e){if(t._tagSet?.has(s))return!0;if(t._tagRegex&&t._tagRegex.length>0)for(const r of t._tagRegex)try{if(r.test(s))return!0}catch{}}return!1}static _sanitizeRulesArray(t){return t.map(e=>this._sanitizeRule(e)).filter(Boolean)}static _sanitizeRule(t){if(!t)return null;const e=t.action==="allow"||t.action==="deny"?t.action:null;if(!e)return null;const s={action:e,comment:t.comment};if(t.severity!=null){const n=(Array.isArray(t.severity)?t.severity:[t.severity]).map(String).filter(Boolean);if(n.length){s.severity=n;const i=[],a=[];for(const l of n){const c=p(l);c?a.push(c):i.push(l)}i.length&&(s._sevSet=new Set(i)),a.length&&(s._sevRegex=a)}}if(t.tag!=null){const n=(Array.isArray(t.tag)?t.tag:[t.tag]).map(String).filter(Boolean);if(n.length){s.tag=n;const i=[],a=[];for(const l of n){const c=p(l);c?a.push(c):i.push(l)}i.length&&(s._tagSet=new Set(i)),a.length&&(s._tagRegex=a)}}if(t.source!=null){const n=(Array.isArray(t.source)?t.source:[t.source]).map(String).filter(Boolean);if(n.length){s.source=n;const i=[],a=[];for(const l of n){const c=p(l);c?a.push(c):i.push(l)}i.length&&(s._srcSet=new Set(i)),a.length&&(s._srcRegex=a)}}if(t.nodeName!=null){const n=(Array.isArray(t.nodeName)?t.nodeName:[t.nodeName]).map(String).filter(Boolean);if(n.length){s.nodeName=n;const i=[],a=[];for(const l of n){const c=p(l);c?a.push(c):i.push(l)}i.length&&(s._nodeSet=new Set(i)),a.length&&(s._nodeRegex=a)}}return s._hits=0,s._allowHits=0,s._denyHits=0,s}static _saveRules(){try{const t=this._rules.map(e=>({action:e.action,severity:e.severity,tag:e.tag,source:e.source,nodeName:e.nodeName,comment:e.comment}));C(S,JSON.stringify(t))}catch{}}static _loadRules(){const t=$(S);if(!t)this._rules=[];else try{const e=JSON.parse(t);Array.isArray(e)?this._rules=this._sanitizeRulesArray(e):this._rules=[]}catch{this._rules=[]}this._rules.length===0&&(this.appendRule({action:"allow",severity:["warn","error"],comment:"Default rule: allow warnings and errors"}),this.appendRule({action:"deny",comment:"Default rule: deny all other logs"}),this._saveRules())}}_.log.bind(_);_.init();const L=(o,t)=>{const e=t.inputs||[],s=t.outputs||{mirrorInputs:!1};m(o,"onNodeCreated",function(){e.forEach(n=>{const i=n.start??1,a=`${n.prefix}${i}`;(!this.inputs||!this.inputs.some(l=>l.name===a))&&this.addInput(a,n.type||"*")}),r.call(this)}),m(o,"onConnectionsChange",function(n,i,a,l,c){if(!l||n!==LiteGraph.INPUT){r.call(this);return}const u=new Error().stack||"";a||!u.includes("LGraphNode.prototype.connect")&&!u.includes("convertToSubgraph")&&!u.includes("pasteFromClipboard")&&!u.includes("LGraphNode.connect")&&!u.includes("loadGraphData")&&this.removeInput(i),e.forEach(f=>{let d=f.start??1,h=!1;for(const g of this.inputs)if(g.name.startsWith(f.prefix)){const y=`${f.prefix}${d++}`;g.name!==y&&(g.name=y),g.link==null&&(h=!0)}h||this.addInput(`${f.prefix}${d}`,f.type||"*")}),r.call(this),this.setDirtyCanvas(!0,!0)});function r(){if(!s.mirrorInputs)return;this.outputs=this.outputs||[];const n=this.inputs?.length||0;for(;this.outputs.length<n;)this.addOutput("any","*");for(;this.outputs.length>n;)this.removeOutput(this.outputs.length-1);for(let i=0;i<n;i++){const a=this.inputs[i],l=this.outputs[i];l.name!==a.name&&(l.name=a.name);let c="*";const u=a.link;if(u!=null&&this.graph?.links?.[u]){const f=this.graph.links[u];c=this.graph.getNodeById(f.origin_id)?.outputs?.[f.origin_slot]?.type||"*"}l.type=c}}};A.registerExtension({name:"ovum.assertovum.dynamicio",async beforeRegisterNodeDef(o,t,e){o.comfyClass==="AssertOvum"&&(_.log({class:"ovum.assertovum.dynamicio",method:"beforeRegisterNodeDef",severity:"info",tag:"registered",nodeName:"AssertOvum"},"registered"),L(o,{inputs:[{prefix:"passthru_",type:"*",start:1},{prefix:"true_",type:"BOOLEAN,*",start:1},{prefix:"false_",type:"BOOLEAN,*",start:1}],outputs:{mirrorInputs:!0}}))}});
